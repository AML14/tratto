#!/bin/bash
# This script runs a test suite generated by a TOG in a given context. Saves
# the output to "output/[tog]/test".

# Get current directory
current_dir=$(realpath "$(dirname "$BASH_SOURCE")")
# Setup global variables
source "${current_dir}/generator/utils/global_variables.sh"

# Setup local variables
tog=$1
target_class=$2
src_dir=$(realpath "$3")
bin_dir=$(realpath "$4")
test_dir="$OUTPUT_DIR/tog-tests/$tog"

# Setup sdkman
source "${UTILS_DIR}/init_sdkman.sh" "${SDKMAN_DIR}"

# Get project root directory
IFS='/' read -ra src_arr <<< "$src_dir"
IFS='/' read -ra bin_arr <<< "$bin_dir"
project_dir=""
for i in "${!src_arr[@]}" "${!bin_arr[@]}"; do
  if [ "${src_arr[i]}" != "${bin_arr[i]}" ]; then
    break
  fi
  project_dir="${project_dir}/${src_arr[i]}"
done
project_dir="${project_dir#/}"

# Copy tests and utilities into target project
cp -r "$test_dir" "$project_dir/evosuite-tests"
cp "$RESOURCES_DIR/evosuite-1.0.6.jar" "$project_dir"
cp "$RESOURCES_DIR/evosuite-standalone-runtime-1.0.6.jar" "$project_dir"
cd "$project_dir" || exit 1

# Switch to Java 8
sdk use java "$JAVA8"

# Run tests
(
  mvn dependency:copy-dependencies
  export CLASSPATH=target/classes:evosuite-standalone-runtime-1.0.6.jar:evosuite-tests:target/dependency/junit-4.12.jar:target/dependency/hamcrest-core-1.3.jar
  # Compile all tests
  find "$project_dir/evosuite-tests" -type f -name "*.java" > java_tests.txt
  while read -r java_test; do
    javac "$java_test"
  done < java_tests.txt
  # Run JUnit
  test_fails="test_fails.txt"
  while read -r java_test; do
    test_class="${java_test#$project_dir/evosuite-tests/}"  # Remove project prefix
    test_class="${test_class%.java}"  # Remove Java suffix
    test_class="${test_class//\//.}"  # Convert to package name
    # Do not run scaffolding files
    if [[ "$test_class" == *ESTest ]]; then
      junit_output=$(java org.junit.runner.JUnitCore "$test_class")
      if [[ $junit_output == *"FAILURES!!!"* ]]; then
        # Get names of all failing tests
        while IFS= read -r line; do
          regex="^[0-9]+\) test[0-9]+\(.*\)$"
          if [[ "$line" =~ $regex ]]; then
            echo "$line" >> "$test_fails"
          fi
        done <<< "$junit_output"
      fi
    fi
  done < java_tests.txt;
  mv "$test_fails" "$OUTPUT_DIR/tog-tests/$tog"
)

# Switch to Java 17
sdk use java "$JAVA17"

# Generate TestOutput record
java -jar "$EXPERIMENT_JAR" "$tog" "generate_test_output" "$target_class" "$src_dir" "$bin_dir" "$ROOT_DIR"

# Cleanup
rm -f "java_tests.txt"
rm -r "evosuite-tests"
rm -f "evosuite-1.0.6.jar"
rm -f "evosuite-standalone-runtime-1.0.6.jar"