#!/bin/bash
# This script generates a test suite for a class using Evosuite.
# Then, for every supported TOG, it creates a variant of teh test suite that uses the TOG's oracle.
# An invocation follows the format,
#     "bash experiment.sh [target-class] [src-dir] [bin-dir] [jar]"
# This script adds the following sub-directories to the output directory, `experiment/output/`:
#     - "evosuite-tests": a test suite generated by EvoSuite
#     - "evosuite-simple-tests": EvoSuite tests split with one assertion per
#                                test
#     - "evosuite-prefixes": EvoSuite simple tests with all assertions removed
#     - "[tog]/input": preprocessed TOG input (if necessary)
#     - "[tog]/oracle": OracleOutputs generated by TOG
#     - "tog-tests/[tog]": a test suite made by inserting TOG oracles into the
#                          EvoSuite prefixes

# Get current directory
current_dir=$(realpath "$(dirname "${BASH_SOURCE}")")
# Setup global variables
source "${current_dir}/generator/utils/global_variables.sh"
# Setup local variables
tog=${1}
target_class=${2}
src_dir=${3}
bin_dir=${4}
classpath_or_jar=${5}
tog_output_dir=${6-${OUTPUT_DIR}}
evosuite_flag=$( [[ "$7" == "true" ]] && echo true || echo false )
project_id=${8-"none"}
bug_id=${9-"none"}
server_port=${10-${SERVER_PORT}}
qualifiers="${target_class%.*}"
evosuite_prefix_path="${tog_output_dir}/evosuite-prefixes"
# Arguments check
if [ "$tog" != "baseline" ] && [ ! -d "${src_dir}" ]; then
  echo -e "The project source directory \"${src_dir}\" does not exist."
  exit 1
elif [ "$tog" != "baseline" ] && [ ! -d "${bin_dir}" ]; then
  echo -e "The system binaries path \"${bin_dir}\" does not exist."
  exit 1
elif [ "$tog" == "tratto" ] && [ ! -e "${classpath_or_jar}" ]; then
  echo -e "The project jar file \"${classpath_or_jar}\" does not exist."
  exit 1
fi
# Check if given TOG is supported
found=0
valid_tog=("jdoctor" "toga" "tratto" "baseline")
for option in "${valid_tog[@]}"; do
  if [ "${option}" = "${tog}" ]; then
    found=1
    break
  fi
done
if [ ! $found -eq 1 ]; then
  echo -e "The given TOG \"${1}\" is not supported. Must be one of: \"jdoctor\", \"toga\", \"tratto\", or \"baseline\"."
  exit 1
fi
# Setup sdkman
source "${UTILS_DIR}/init_sdkman.sh" "${SDKMAN_DIR}"
# Switch to Java 17
sdk use java "${JAVA17}"
# Setup experiments
bash "${UTILS_DIR}/experiment_setup.sh"
# Generate prefixes
if [ evosuite_flag == true ]; then
  echo "Evosuite test suite generator not implemented yet. The script ends."
  exit 1
else
  echo "Generation of EvoSuite tests skipped for class ${target_class} (supposed has already been generated)."
fi
# Generate oracles using TOG
if [ "${tog}" == "jdoctor" ]; then
  bash ./generator/jdoctor.sh "${target_class}" "${src_dir}" "${classpath_or_jar}" "${tog_output_dir}"
elif [ "${tog}" == "toga" ]; then
  bash ./generator/toga.sh "${target_class}" "${src_dir}" "${classpath_or_jar}" "${tog_output_dir}" "${project_id}" "${bug_id}"
elif [ "${tog}" == "tratto" ]; then
  bash ./generator/tratto.sh "${target_class}" "${src_dir}" "${classpath_or_jar}" "${tog_output_dir}" "${server_port}"
fi
# Insert oracles into EvoSuite prefixes
if [ "$tog" != "baseline" ]; then
  echo "Insert oracles in test prefixes"
  tog_oracles_path="${tog_output_dir}/${tog}-oracles"
  java -jar "${EXPERIMENT_JAR}" "insert_oracles" "${evosuite_prefix_path}" "${tog_oracles_path}" "${classpath_or_jar}"
else
  echo "Skipping oracle insertion in test prefixes for baseline"
  baseline_tests_path="${tog_output_dir}/${tog}-tests"
  output_test_suite_path="${tog_output_dir}/${tog}-test-suite"
  mkdir -p "$baseline_tests_path"
  mkdir -p "$output_test_suite_path"
  cp -r "${evosuite_prefix_path}/"* "${baseline_tests_path}"
fi
# Run tests and generate output
if [ "$project_id" != "none" ]; then
  echo "Running tests and generating test output"
  # Execute tests with evosuite
  bash ./runner_d4j.sh "$tog" "$project_id" "$bug_id" "${tog_output_dir}" "${tog_output_dir}/${tog}-test-suite"
  #if [ ! -d "${tog_output_dir}/${tog}-tests/${project_id}/${bug_id}" ]; then
  #  mkdir -p "${tog_output_dir}/${tog}-tests/${project_id}/${bug_id}"
  #fi
  #find "${tog_output_dir}/${tog}-tests" -mindepth 1 -maxdepth 1 -type d -not -path "${tog_output_dir}/${tog}-tests/${project_id}/${bug_id}" -exec mv -t "${tog_output_dir}/${tog}-tests/${project_id}/${bug_id}" {} +
  java -jar "$EXPERIMENT_JAR" generate_defects4j_output "$tog" "$target_class" "$project_id" "$bug_id" "${tog_output_dir}/${tog}-tests" "${tog_output_dir}/${tog}-test-suite"
else
  echo "Running tests not yet implemented for non-defects4j projects."
fi
echo "Experiment complete!"