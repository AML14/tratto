import data.OperationType;
import data.OracleOutput;
import data.TogType;

import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.List;

/**
 * This class is the main file used in the build {@code experiment.jar}, with
 * all necessary operations for the experiment pipeline, including:
 * <ul>
 *     <li>Removing oracles</li>
 *     <li>Inserting oracles</li>
 *     <li>Preprocessing TOG input</li>
 *     <li>Postprocessing TOG output</li>
 *     <li>Summarizing test suite results</li>
 *     <li>Summarizing Defects4J results</li>
 *     <li>Combining Defects4J results into a complete summary</li>
 * </ul>
 * The various operations require different arguments, following the format:
 * <ul>
 *     <li>{@code java -jar experiment.jar remove_oracles
 *     [testDir]}</li>
 *     <li>{@code java -jar experiment.jar insert_oracles
 *     [togType] [fullyQualifiedName] [jarPath]}</li>
 *     <li>{@code java -jar experiment.jar generate_tog_input
 *     [togType] [fullyQualifiedName] [srcDir]}</li>
 *     <li>{@code java -jar experiment.jar generate_oracle_output
 *     [togType] [srcDir]}</li>
 *     <li>{@code java -jar experiment.jar generate_test_output
 *     [togType] [fullyQualifiedName] [srcDir] [binDir] [fileSuffix]}</li>
 *     <li>{@code java -jar experiment.jar generate_defects4j_output
 *     [togType] [projectName] [bugID] [fullyQualifiedName]}</li>
 *     <li>{@code java -jar experiment.jar combine_defects4j_output
 *     [togType]}</li>
 * </ul>
 */
public class Tog {
    private static final Path output = Paths.get("output");

    /**
     * Inserts the OracleOutput records generated by a TOG into the test
     * prefixes generated by EvoSuite.
     *
     * @param togType a TOG
     * @param fullyQualifiedName the class under test
     * @param jar the JAR of the project under test
     */
    private static void insertOracles(
            TogType togType,
            String fullyQualifiedName,
            Path jar
    ) {
        Path oraclesPath = output.resolve(Paths.get(togType.toString().toLowerCase(), "oracle", "oracle_output.json"));
        List<OracleOutput> oracleOutputs = FileUtils.readJSONList(oraclesPath, OracleOutput.class);
        OracleInserter.insertOracles(togType, fullyQualifiedName, oracleOutputs, jar);
    }

    /**
     * Preprocess the input to the necessary format for a given TOG.
     *
     * @param togType a TOG
     * @param fullyQualifiedName the class under test
     * @param srcDir the source directory of the project under test
     */
    private static void generateTogInput(
            TogType togType,
            String fullyQualifiedName,
            Path srcDir
    ) {
        if (togType == TogType.TOGA) {
            TogUtils.generateTOGAInput(srcDir, fullyQualifiedName);
        }
    }

    /**
     * Converts a TOG output to a list of OracleOutput records.
     *
     * @param togType a TOG
     * @param srcDir the source directory of the project under test
     */
    private static void generateOracleOutput(
            TogType togType,
            Path srcDir
    ) {
        if (togType == TogType.JDOCTOR) {
            TogUtils.jDoctorToOracleOutput();
        } else if (togType == TogType.TOGA) {
            TogUtils.togaToOracleOutput(srcDir);
        } else if (togType == TogType.TRATTO) {
            TogUtils.trattoToOracleOutput(srcDir);
        }
    }

    /**
     * Generates a TestOutput record to summarize a test suite generated by a
     * TOG.
     *
     * @param tog a TOG
     * @param fullyQualifiedName the fully qualified name of the class under
     *                           test
     * @param srcDir the source directory of the project under test
     * @param binDir the binaries directory of the project under test
     */
    private static void generateTestOutput(
            TogType tog,
            String fullyQualifiedName,
            Path srcDir,
            Path binDir
    ) {
        TogUtils.writeTestOutput(
                tog,
                fullyQualifiedName,
                srcDir,
                binDir
        );
    }

    /**
     * Creates a Defects4JOutput record to get statistics for a test suite
     * generated by a TOG for a class in a given bug in a given project
     *
     * @param togType a TOG
     * @param projectName the name of the project under test
     * @param bugID the bug id
     * @param fullyQualifiedName the class under test
     */
    private static void generateDefects4JOutput(
            TogType togType,
            String projectName,
            int bugID,
            String fullyQualifiedName
    ) {
    }

    /**
     * Combines all Defects4JOutputs into a singular Defects4JOutput record
     * that summarizes all bugs in all projects.
     *
     * @param togType a TOG
     */
    private static void combineDefects4JOutput(
            TogType togType
    ) {
    }

    /**
     * The main method handles all invocations of the JAR file.
     *
     * @param args arguments passed for each JAR invocation
     */
    public static void main(String[] args) {
        OperationType operationType = OperationType.valueOf(args[0].toUpperCase());
        switch (operationType) {
            case REMOVE_ORACLES -> OracleRemover.removeOracles(Paths.get(args[1]));
            case INSERT_ORACLES -> insertOracles(
                    TogType.valueOf(args[1].toUpperCase()),
                    args[2],
                    Paths.get(args[3])
            );
            case GENERATE_TOG_INPUT -> generateTogInput(
                    TogType.valueOf(args[1].toUpperCase()),
                    args[2],
                    Paths.get(args[3])
            );
            case GENERATE_ORACLE_OUTPUT -> generateOracleOutput(
                    TogType.valueOf(args[1].toUpperCase()),
                    Paths.get(args[2])
            );
            case GENERATE_TEST_OUTPUT -> generateTestOutput(
                    TogType.valueOf(args[1].toUpperCase()),
                    args[2],
                    Paths.get(args[3]),
                    Paths.get(args[4])
            );
            case GENERATE_DEFECTS4J_OUTPUT -> generateDefects4JOutput(
                    TogType.valueOf(args[1].toUpperCase()),
                    args[2],
                    Integer.parseInt(args[3]),
                    args[4]
            );
            case COMBINE_DEFECTS4J_OUTPUT -> combineDefects4JOutput(
                    TogType.valueOf(args[1].toUpperCase())
            );
            default -> throw new IllegalArgumentException("Unknown operation " + operationType);
        }
    }
}
